<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì—°ìŠµìƒ í•«í´ë¦½ ì±„ì ì§€</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
        html, body { height: 100%; margin: 0; padding: 0; background-color: #f0f2f5; }
        body { font-family: 'Pretendard', -apple-system, sans-serif; display: flex; flex-direction: column; align-items: center; }

        /* ì»¨í…Œì´ë„ˆ: ë„ˆë¹„ 98%ë¡œ í™•ì¥, ë†’ì´ëŠ” í™”ë©´ì— ë§ì¶¤ */
        .container { 
            width: 98%; 
            height: 100vh; 
            background: white; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 0 25px rgba(0,0,0,0.15);
        }

        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 25px 30px; border-bottom: 3px solid #eee;
        }
        h2 { color: #1a73e8; margin: 0; font-size: 32px; letter-spacing: -1px; } /* ì œëª© ëŒ€í­ í™•ëŒ€ */
        
        /* íƒ­ ì˜ì—­ í™•ëŒ€ */
        .tabs { display: flex; gap: 10px; padding: 0 30px; background: #fff; border-bottom: 2px solid #dee2e6; }
        .tab { 
            padding: 15px 35px; cursor: pointer; background: #f8f9fa; border: 2px solid #dee2e6; 
            border-bottom: none; border-radius: 10px 10px 0 0; font-weight: 800; color: #555; font-size: 18px; margin-top: 15px;
            transition: all 0.2s;
        }
        .tab.active { background: #1a73e8; color: white; border-color: #1a73e8; transform: translateY(-2px); }
        
        .btn-group { display: flex; gap: 15px; }
        .btn-add { background: linear-gradient(135deg, #6e8efb, #a777e3); color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; box-shadow: 0 4px 10px rgba(110, 142, 251, 0.3); }
        .btn-reset { background: #ff4757; color: white; border: none; padding: 12px 25px; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; }

        /* í…Œì´ë¸” ì˜ì—­: ìƒí•˜ ìŠ¤í¬ë¡¤ í—ˆìš© */
        .table-wrapper { 
            flex: 1; 
            overflow: auto; 
            background: #fff;
        }
        table { border-collapse: collapse; width: 100%; min-width: 1000px; table-layout: fixed; }
        
        /* ì…€ ë†’ì´ì™€ í°íŠ¸ í¬ê¸° ëŒ€í­ í™•ëŒ€ */
        th, td { border: 1px solid #ddd; padding: 0; text-align: center; height: 75px; font-size: 20px; } /* ë†’ì´ 75pxë¡œ ì¦ê°€ */
        th { background-color: #f8f9fa; color: #333; position: sticky; top: 0; z-index: 20; height: 80px; font-size: 20px; border-bottom: 3px solid #dee2e6; }
        
        /* ê³ ì • ì»¬ëŸ¼ ì„¤ì • */
        .name-col { background-color: #ffffff !important; font-weight: 900; position: sticky; left: 0; z-index: 30; border-right: 3px solid #dee2e6; width: 140px; color: #000; }
        .count-col { background-color: #fcfcfc !important; font-weight: bold; position: sticky; left: 140px; z-index: 30; border-right: 3px solid #dee2e6; width: 90px; color: #1a73e8; }
        
        /* ì…ë ¥ì°½ ë””ìì¸: í…ìŠ¤íŠ¸ ê°•ì¡° */
        input[type="text"] { 
            width: 100%; height: 100%; border: none; text-align: center; 
            font-size: 20px; font-weight: 800; background: transparent; outline: none; box-sizing: border-box;
            transition: background 0.2s;
        }
        input[type="text"]:focus { background: #f0f7ff; border: 3px inset #1a73e8; }
        
        .week-col { width: 180px; } /* ì£¼ì°¨ ì¹¸ ë„ˆë¹„ í™•ëŒ€ */
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2 onclick="location.reload()" style="cursor:pointer">ğŸ¬ ì—°ìŠµìƒ í•«í´ë¦½ ì±„ì ì§€</h2>
        <div class="btn-group">
            <button class="btn-reset" onclick="forceReset()">ì „ì²´ ë¦¬ì…‹</button>
            <button class="btn-add" onclick="addNextWeek()">+ ìƒˆ ì£¼ì°¨ ì¶”ê°€</button>
        </div>
    </div>

    <div class="tabs" id="tabGroup">
        <div id="tab1" class="tab active" onclick="changeQuarter(1)">1ë¶„ê¸°</div>
        <div id="tab2" class="tab" onclick="changeQuarter(2)">2ë¶„ê¸°</div>
        <div id="tab3" class="tab" onclick="changeQuarter(3)">3ë¶„ê¸°</div>
        <div id="tab4" class="tab" onclick="changeQuarter(4)">4ë¶„ê¸°</div>
    </div>

    <div class="table-wrapper">
        <table id="scoreTable">
            <thead>
                <tr id="headerRow">
                    <th class="name-col">ë‹‰ë„¤ì„</th>
                    <th class="count-col">ì œì¶œ</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDnfjiMOibQiTMwSBhKPJ7nMo8sALjDrzQ",
        authDomain: "hotclip-checker.firebaseapp.com",
        projectId: "hotclip-checker",
        storageBucket: "hotclip-checker.firebasestorage.app",
        messagingSenderId: "267152120477",
        appId: "1:267152120477:web:edda4bf32b52dc20ddd274",
        measurementId: "G-SZQYFGBX3J",
        databaseURL: "https://hotclip-checker-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentQuarter = 1; 
    const initialFullData = {
        "ë°¤ë² ": ["1 PASS", "ë¯¸ì œì¶œ"], "ìœµë¡œë¡œ": ["ë¯¸ì œì¶œ", "2 PASS"], "ì°Œë¡œ": ["1 PASS / 1 FAIL", "ë¯¸ì œì¶œ"],
        "í”„í•˜": ["1 FAIL", "ë¯¸ì œì¶œ"], "í˜¸ë°œ": ["2 PASS", "1 PASS"], "ê³µë„ë¦¬": ["ë¯¸ì œì¶œ", "ë¯¸ì œì¶œ"],
        "í•œì„¸í˜„": ["2 FAIL", "1 PASS / 1 FAIL"], "ê¹€ì†œëƒ": ["1 FAIL", "1 FAIL"], "ë„í˜": ["2 PASS", "2 PASS"],
        "ë£¬ë‚˜": ["1 PASS", "ë¯¸ì œì¶œ"], "ë¦¬í¼ì„": ["1 PASS / 1 FAIL", "1 PASS / 1 FAIL"], "ë§ˆë¦¬íˆ": ["2 FAIL", "2 FAIL"],
        "ë°¤ë¬¸": ["2 PASS", "ë¯¸ì œì¶œ"], "ë°±ì†Œë¼": ["2 PASS", "2 PASS"], "ìš”ë‚˜ì¹´": ["2 PASS", "2 PASS"],
        "ìœ ë¦¬ì—": ["1 FAIL", "ë¯¸ì œì¶œ"], "ìœ¤ì„¸ëŒ": ["ë¯¸ì œì¶œ", "ë¯¸ì œì¶œ"], "ì§€ì˜¤": ["1 FAIL", "1 FAIL"], "í–„ì©Œêµ¬": ["1 PASS", "2 PASS"]
    };
    const nameList = Object.keys(initialFullData);

    function forceReset() {
        if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            db.ref('traineeData').set(initialFullData).then(() => {
                currentQuarter = 1;
                updateTabUI();
            });
        }
    }

    function changeQuarter(q) {
        currentQuarter = q;
        updateTabUI();
        db.ref('traineeData').once('value', snapshot => {
            renderTable(snapshot.val());
        });
    }

    function updateTabUI() {
        document.querySelectorAll('.tab').forEach((t, idx) => {
            t.classList.toggle('active', idx + 1 === currentQuarter);
        });
    }

    function getWeekInfo(index) {
        const startYear = 2026;
        const startMonth = 2; 
        const totalMonthsPassed = Math.floor(index / 4);
        const absoluteMonths = (startMonth - 1) + totalMonthsPassed;
        const year = startYear + Math.floor(absoluteMonths / 12);
        const month = (absoluteMonths % 12) + 1;
        const weekNum = (index % 4) + 1;
        const quarter = Math.ceil(month / 3);
        return { year, month, weekNum, quarter };
    }

    db.ref('traineeData').on('value', snapshot => {
        const data = snapshot.val();
        if (data) renderTable(data);
    });

    function renderTable(data) {
        if (!data) return;
        const header = document.getElementById('headerRow');
        const tbody = document.getElementById('tableBody');
        const firstPerson = Object.keys(data)[0];
        const allScores = data[firstPerson] || [];

        header.innerHTML = '<th class="name-col">ë‹‰ë„¤ì„</th><th class="count-col">ì œì¶œ</th>';
        const visibleIndices = [];
        
        allScores.forEach((_, idx) => {
            const info = getWeekInfo(idx);
            if (info.quarter === currentQuarter) {
                visibleIndices.push(idx);
                const th = document.createElement('th');
                th.className = 'week-col';
                const yearLabel = (info.month === 1 && info.weekNum === 1) ? `${info.year}ë…„ ` : "";
                th.innerText = `${yearLabel}${info.month}ì›” ${info.weekNum}ì£¼`;
                header.appendChild(th);
            }
        });

        tbody.innerHTML = '';
        nameList.forEach(name => {
            const row = document.createElement('tr');
            const scores = data[name] || [];
            const submitCount = scores.filter(s => s && s !== "" && !s.includes("ë¯¸ì œì¶œ")).length;
            
            let cells = `<td class="name-col">${name}</td>`;
            cells += `<td class="count-col">${submitCount}</td>`;
            
            visibleIndices.forEach(idx => {
                const score = scores[idx] || "";
                cells += `<td><input type="text" value="${score}" ${applyStyle(score)} onchange="updateFirebase('${name}', ${idx}, this.value)"></td>`;
            });
            row.innerHTML = cells;
            tbody.appendChild(row);
        });
    }

    function applyStyle(val) {
        const v = val.toUpperCase();
        if (v.includes("PASS") && v.includes("FAIL")) return 'style="color: #FF82AB; font-weight:800;"';
        if (v.includes("PASS")) return 'style="color:#2ecc71; font-weight:800;"';
        if (v.includes("FAIL")) return 'style="color:#e74c3c; font-weight:800;"';
        if (v.includes("ë¯¸ì œì¶œ")) return 'style="color:#adb5bd;"';
        return 'style="color:#1c1e21;"';
    }

    function updateFirebase(name, index, value) {
        db.ref(`traineeData/${name}/${index}`).set(value);
    }

    function addNextWeek() {
        db.ref('traineeData').once('value', snapshot => {
            const data = snapshot.val() || {};
            let newIdx = 0;
            nameList.forEach(name => {
                if(!data[name]) data[name] = [];
                data[name].push("");
                newIdx = data[name].length - 1;
            });
            const newInfo = getWeekInfo(newIdx);
            db.ref('traineeData').set(data).then(() => {
                if (currentQuarter !== newInfo.quarter) {
                    currentQuarter = newInfo.quarter;
                    updateTabUI();
                    renderTable(data);
                }
            });
        });
    }
</script>
</body>
</html>